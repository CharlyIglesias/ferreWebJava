<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
<head>
    <style>
        .card-columns{
            max-width: 32em;
            display: inline-table;
        }
        .card-title{
            font-size: 23px;
        }
        .card-text{
            font-size: 17px;
        }
        .nodecored{
            text-decoration: none;
            color: black;
        }
        .grandes{
            padding: 12px 35px !important;
            text-align: center;
            text-decoration: none;
        }
        .lefted{
            margin-left: 19%;
            margin-bottom: 0;
        }
        .form-control{
            margin-bottom: 15px;
        }
        .options{
            max-width: 44%;
        }

        #exp-invalid{
            color: red;
            display:none;
        }
        
        .inputazo{
          display: none !important;
        }
        .botonazo{
          display: none !important;
        }

    </style>
        
        <title>Payment</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js" integrity="sha384-6khuMg9gaYr5AxOqhkVIODVIvm9ynTT5J4V1cfthmT+emCG6yVmEZsRHdxlotUnm" crossorigin="anonymous"></script>
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.20/datatables.min.css"/>
        <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.20/datatables.min.js"></script>
        <script> 
            var subtotal = 0;
            $(function(){
              $("#includedContent").load("index.html");
              $('#footer').load("footer.html");
            });
            
            $(document).ready(function () {
                createTable('All');
            });

            function createTable(status) {
                emptyTableMessage= "You don't have any products.";
                    table = $('#myTable').DataTable({
                        "ajax":{
                            "url" : 'http://localhost:8081/getCart?cartToken='+sessionStorage.getItem("cartToken"),
                            "dataSrc": '', 
                        },
                        "paging": false,
                        "info": false,
                        "searching": false,
                        "order": [1,'asc'],
                        "language": {
                            "emptyTable": emptyTableMessage
                        },
                        "columns": [
                            {"data": "producto.titulo", "searchable": true, "orderable": false},
                            {"data": "producto.descripcion", "searchable": true, "orderable": false},
                            {"data": "producto.valor", "searchable": false, "orderable": false, "render": function(data){
                                    return "$"+data;
                            }},
                            {"data": "cantidad", "searchable": true, "orderable": false},
                            {"data": "producto.id", "searchable": true, "orderable": false, "render": function(data, type, row){
                                    var price = 0;
                                    price = row.producto.valor * row.cantidad;
                                    return "$"+price;
                            }},
                        ],
                    });

                    table.on( 'xhr', function () {
                        var json = table.ajax.json();
                        var JsonData = json;
                        var envioFee = 0;
                        var options = "<option value='{{ user.id }}'>Me</option>";
                        JsonData.forEach(index =>{
                           subtotal += index.producto.valor * index.cantidad;
                           envioFee = index.carrito.envio.price;
                        });
                        $("#subtotal").html("$"+subtotal);
                        //$("#total").html("$"+subtotal);
                        $("#shipping-fee").html((envioFee == 0) ? "FREE" : "$"+envioFee);
                        var totalPrice = parseFloat(subtotal) + parseFloat(envioFee);
                        console.log(totalPrice);
                        $("#total").html("$"+totalPrice);
                    });
            }
            
            
            $(document).on('keypress paste keyup','[id=cardNumber]',function(){
                var key = event.keyCode || event.charCode;
                if( key == 8 || key == 46 )
                    return false;
                if($(this).val().length == 4 || $(this).val().length == 9 || $(this).val().length == 14) {
                    $(this).val($(this).val()+" ");
                    focus = false;
                }

            });
            $(document).on('keypress paste keyup','[id=cardExpiration]',function(){
                var key = event.keyCode || event.charCode;
                if( key == 8 || key == 46 )
                    return false;

                if($(this).val().length === 2) {
                    $(this).val($(this).val()+"/");
                    focus = false;
                }


                if($(this).val().length > 4){
                    month = $(this).val().slice(0, 2);
                    year =  20+$(this).val().slice(3,6);
                    var today = new Date();
                    var actual = today.getFullYear();
                     if(month > 12 || year< actual){
                        $('#exp-invalid').show();
                     }else{
                        $('#exp-invalid').hide();
                    }
                }

            });
            
            function createPedido(){
                $.post("http://localhost:8081/createPedido", {cartToken: sessionStorage.getItem("cartToken")}, function(){
                    alert("Order Made Successfully");
                    sessionStorage.setItem("cartToken", null);
                    window.location.replace("/EvidenciaFinalFront/home.html?searchString=");
                });
            }
        </script> 
    </head>
    <body>
        <div id="includedContent"></div>
        <br>
        <div class="row" style="margin-left: 3%">
            <div class="col-4">
                <p class="font-weight-light" style="font-size:33px; text-align: right; color: #6c757d">1. Shopping Cart</p>
            </div>
            <div class="col-4">
                <p class="font-weight-light" style="font-size:33px; text-align: center; color: #6c757d">2. Shipping Details</p>
            </div>
            <div class="col-4">
                <p class="font-weight-light" style="font-size:33px; text-align: left;">3. Payment Options</p>
            </div>
        </div>
        <div class="progress" style="height: 1px; margin-left: 16%; max-width: 77%">
            <div class="progress-bar" role="progressbar" style="width: 100%; background-color: #6c757d" aria-valuenow="21" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        
        <br>
        
        <div class="row">
        <div class="col-8" style="">
            <div class="accordion" id="accordionExample" style="margin-left:25%; margin-right: 12%;">
            <div class="card">
              <div class="card-header" id="headingOne">
                <h2 class="mb-0">
                  <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                    Credit Card
                  </button>
                </h2>
              </div>

              <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordionExample">
                <div class="card-body">
                 <form class="form">
                    <div class="row" style="margin-top: 20px">
                        <div class="col-6">
                          <input type="text" class="form-control" placeholder="Card Number" maxlength="19" id="cardNumber">
                        </div>
                        <div class="col">
                          <input type="text" class="form-control" placeholder="CVV" maxlength="3" id="cvv">
                        </div>
                        <div class="col">
                          <input type="text" class="form-control" placeholder="MM/YY" maxlength="5" id="cardExpiration">
                          <div id="exp-invalid" class="row" ><i class="fas fa-exclamation-triangle"></i> Invalid expiration date </div>
                        </div>
                    </div>
                    <input type="text" class="form-control" placeholder="Card Holder Name" id="cardHolder">
                 </form>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header" id="headingTwo">
                <h2 class="mb-0">
                  <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                    PayPal
                  </button>
                </h2>
              </div>
              <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionExample">
                <div class="card-body">
                 <p class="font-weight-light centered" style="font-size:14px;">Nice try, but we do not accept PayPal (by now).</p>
                 <p class="font-weight-light centered" style="font-size:14px;">Try with Credit Card instead.</p>
                </div>
              </div>
            </div>
            </div>
          </div>
        <div class="col-4">
            <p class="font-weight-light" style="font-size:33px; text-align: left;">Summary</p>
            <hr style="border-top: 1px solid #e6e6e6; margin-top: 1rem; width: 100%">
                <table id="myTable" class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Price</th>
                            <th>Qty</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                </table>
            <hr style="border-top: 1px solid #e6e6e6; margin-top: 1rem; width: 100%">
            <div class="row">
                <div class="col-6">
                    <div class="row">
                    <p class="font-weight-light lefted" style="font-size: 23px">SUBTOTAL</p>
                    </div>
                    <div class="row">
                    <p class="font-weight-light lefted" style="font-size: 23px">SHIPPING</p>
                    </div>
                </div>
                <div class="col-6">
                    <div class="row">
                        <p class="font-weight-light lefted" style="font-size: 23px" id="subtotal">20</p>
                    </div>
                    <div class="row">
                        <p class="font-weight-light lefted" style="font-size: 23px" id="shipping-fee">FREE</p>
                    </div>
                    
                </div>
            </div>
            <hr style="border-top: 1px solid #e6e6e6; margin-top: 1rem; width: 100%">
            <div class="row">
                <div class="col-6">
                    <div class="row">
                    <p class="font-weight-light lefted" style="font-size: 23px">TOTAL</p>
                    </div>
                </div>
                <div class="col-6">
                    <div class="row">
                    <p class="font-weight-bold lefted" style="font-size: 23px" id="total">$1232</p>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <hr style="border-top: 1px solid #e6e6e6; margin-top: 0px; width: 100%">
        <div class="row" style="margin-left:18%">
            <a href="shipping.html" style="margin-right: 2%"><button class="btn btn-outline-secondary my-2 my-sm-0 grandes" type="submit">Back</button></a>
            <button class="btn btn-secondary my-2 my-sm-0 grandes" onClick="createPedido()">Pay</button>
        </div>
        <br>
        <hr style="border-top: 1px solid #e6e6e6; margin-top: 0px; width: 66%">
        <div id="footer"></div>
    </body>
</html>
