<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
<head>
    <style>
        .card-columns{
            max-width: 32em;
            display: inline-table;
        }
        .card-title{
            font-size: 23px;
        }
        .card-text{
            font-size: 17px;
        }
        .nodecored{
            text-decoration: none;
            color: black;
        }
        .grandes{
            padding: 12px 35px !important;
            text-align: center;
            text-decoration: none;
        }
        .lefted{
            margin-left: 19%;
        }
        
        .inputazo{
          display: none !important;
        }
        .botonazo{
          display: none !important;
        }
    </style>
        
        <title>Shopping Cart</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js" integrity="sha384-6khuMg9gaYr5AxOqhkVIODVIvm9ynTT5J4V1cfthmT+emCG6yVmEZsRHdxlotUnm" crossorigin="anonymous"></script>
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.20/datatables.min.css"/>
        <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.20/datatables.min.js"></script>
    <script> 
            $(function(){
              $("#includedContent").load("index.html");
              $('#footer').load("footer.html");
            });
        </script> 
    </head>
    <body>
        <div id="includedContent"></div>
        <br>
        <div class="row" style="margin-left: 3%">
            <div class="col-4">
                <p class="font-weight-light" style="font-size:33px; text-align: right;">1. Shopping Cart</p>
            </div>
            <div class="col-4">
                <p class="font-weight-light" style="font-size:33px; text-align: center; color: #6c757d">2. Shipping Details</p>
            </div>
            <div class="col-4">
                <p class="font-weight-light" style="font-size:33px; text-align: left; color: #6c757d">3. Payment Options</p>
            </div>
        </div>
        <div class="progress" style="height: 1px; margin-left: 16%; max-width: 77%">
            <div class="progress-bar" role="progressbar" style="width: 26%; background-color: #6c757d" aria-valuenow="21" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <br>
        <div class="row">
        <div class="col-8" style="">
            <p class="font-weight-light" style="font-size:33px; text-align: left; padding-left: 26.8%">Shopping Cart</p>
            
            <hr style="border-top: 1px solid #e6e6e6; margin-top: 0px; width: 66%">
            
            <div style="margin-left: 26.8%" width="73%">
                <table id="myTable" class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Price</th>
                            <th>Image</th>
                            <th>Qty</th>
                            <th></th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
        <div class="col-4">
            <p class="font-weight-light" style="font-size:33px; text-align: left;">Summary</p>
            <hr style="border-top: 1px solid #e6e6e6; margin-top: 1rem; width: 100%">
            <hr style="border-top: 1px solid #e6e6e6; margin-top: 1rem; width: 100%">
            <div class="row">
                <div class="col-6">
                    <div class="row">
                        <p class="font-weight-light lefted" style="font-size: 23px">SUBTOTAL</p>
                    </div>
                </div>
                <div class="col-6">
                    <div class="row">
                        <p class="font-weight-light lefted" style="font-size: 23px" id="subtotal"></p>
                    </div>
                </div>
            </div>
            
            <hr style="border-top: 1px solid #e6e6e6; margin-top: 1rem; width: 100%">
            <div class="row">
                <div class="col-6">
                    <div class="row">
                    <p class="font-weight-light lefted" style="font-size: 23px">TOTAL</p>
                    </div>
                </div>
                <div class="col-6">
                    <div class="row">
                    <p class="font-weight-bold lefted" style="font-size: 23px" id="total"></p>
                    </div>
                </div>
            </div>
        </div>
        
        </div>
        <br>
        <hr style="border-top: 1px solid #e6e6e6; margin-top: 0px; width: 66%">
        <div class="row" style="margin-left:18%">
            <a href="shipping.html"><button class="btn btn-secondary my-2 my-sm-0 grandes" type="submit">Next</button></a>
        </div>
        <br>
        <hr style="border-top: 1px solid #e6e6e6; margin-top: 0px; width: 66%">
        <div id="footer"></div>
    </body>
    <script>
        /* 
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
    var table;
    $(document).ready(function () {
        
        createTable('All');

    });

    function createTable(status) {
        emptyTableMessage= "You don't have any products.";
            table = $('#myTable').DataTable({
                "ajax":{
                    "url" : 'http://localhost:8081/getCart?cartToken='+sessionStorage.getItem("cartToken"),
                    "dataSrc": '', 
                },
                "paging": false,
                "info": false,
                "searching": false,
                "order": [1,'asc'],
                "language": {
                    "emptyTable": emptyTableMessage
                },
                "columns": [
                    {"data": "producto.titulo", "searchable": true, "orderable": false},
                    {"data": "producto.descripcion", "searchable": true, "orderable": false},
                    {"data": "producto.valor", "searchable": false, "orderable": false, "render": function(data){
                            return "$"+data;
                    }},
                    {"data": "producto.foto_url","orderable": false, "render": function ( data, type, row ) {

                            return '<a target="_blank" href="'+data+'"style="max-width: 75px;"><img src="'+data+'" style="width:50%; max-width: 65px;"></a>';  
                        // Combine the first and last names into a single table field
                    } },
                    {"data": "cantidad", "searchable": true, "orderable": false, "render": function(data, type, row){
                            return "<input onfocusout='changeQuantity("+row.producto.id+");' type='number' min='1' max='100' class='quantity-product-"+row.producto.id+"' value='"+data+"'></input>"
                    }},
                    {"data": "producto.id", "searchable": true, "orderable": false, "render": function(data, full){
                            return "<button class='btn btn-danger delete-product-"+data+"' onClick='deleteAction("+data+");'>Delete</button>"
                    }},
                ],
            });
            
            table.on( 'xhr', function () {
                reloadPrices();
            });
    }
    
    function deleteAction(productId){
        $.post("http://localhost:8081/deleteFromCart", {productId, "cartToken": sessionStorage.getItem("cartToken")}, function(data){
            alert("Product deleted from cart");
            $(".delete-product-"+productId).closest("tr").remove();
        });
    }
    
    function changeQuantity(productId){
        $.post("http://localhost:8081/changeQuantity", {productId, "cartToken": sessionStorage.getItem("cartToken"), "quantity": $(".quantity-product-"+productId).val()}, function(data){
            console.log($(".quantity-product-"+productId).val());
            reloadPrices();
        });
    }
            
    function reloadPrices(){
        var json = table.ajax.json();
        var JsonData = json;
        var options = "<option value='{{ user.id }}'>Me</option>";
        var total = 0;
        JsonData.forEach(index =>{
        console.log($(".quantity-product-"+index.producto.id).val());
           total += index.producto.valor * (($(".quantity-product-"+index.producto.id).val() !== undefined) ?  $(".quantity-product-"+index.producto.id).val() : index.cantidad);
        });
        $("#subtotal").html("$ "+total);
        $("#total").html("$ "+total);
    }
    
    
    
           

    </script>
</html>
